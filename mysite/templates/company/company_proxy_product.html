{% extends  'base.html' %}
{% load static %}
{% block title%}
<title>廠商代理資訊</title>  
{% endblock %}

{% block header%}
    <!-- Datatables -->
    <link href="{% static '/dashboard_plugin/datatable/datatables.net-bs/css/dataTables.bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'dashboard_plugin/datatable/datatables.net-buttons-bs/css/buttons.bootstrap.min.css' %}" rel="stylesheet">
    <!-- iCheck -->
    <link href="{% static '/dashboard_plugin/datatable/iCheck/skins/flat/green.css' %}" rel="stylesheet">
{% endblock %}

{% block css %}

<style>
    *{
        font-family:"Arial","蘋方體","微軟正黑體",sans-serif
      }
    body {
        background-color:rgb(241, 241, 241);
    }
    .lightbox{
        z-index:5000;
        position: fixed;
        left: 0;    /* 靠左上角定位 */
        top: 0;	  
        width: 100%;
        height: 100vh;    /* view-width. height  */
        background-color: rgba(0,0,0,.5);
        align-items: center;
        justify-content: center;
        display: none;

    }
    .lightbox.active{
        display: flex;
    }
    .content{
        width: 1200px;
        height: 800px;
        background-color: #ccc;
        /*align-items: center;
        justify-content: center;  */
        position: relative;
        overflow-y:auto;

    }
    .close{
        z-index:9999;
        position: absolute;
        top: 0;
        right: 0;
    }

    .lightbox2{
        z-index:9999;
        position: fixed;
        left: 0;    /* 靠左上角定位 */
        top: 0;	  
        width: 100%;
        height: 100vh;    /* view-width. height  */
        background-color: rgba(0,0,0,.5);
        align-items: center;
        justify-content: center;
        display: none;
    }
    .lightbox2.active{
        display: flex;
    }
    .content_delete_check{
        width: 250px;
        height: 150px;
        background-color: #ccc;
        border-radius: 10px;
        display:flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow-y:auto;

    }


</style>
{% endblock%}

{% block body%}

<!-- page content -->
<div class="container" role="main">


    <div class="lightbox2">
        <div class="content_delete_check">
            <div>
                <h5>確定要刪除資料？</h5><br>
                <div>
                    <button class="btn btn-success" id='delete_true'>確認刪除</button>
                    <button class="btn btn-danger" id="close_delete_check">取消</button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="lightbox">
        <div class="content">
            <div class="card col-12" style="height: 100%;">
                <br>
                <h5 style="text-align: center;">商品資料更新</h5>
                <div class="card-body">
                    {% csrf_token %}
                    <div class="row my-3">
                        <div class="col-lg-3 col-md-12 col-12">
                            <h6>廠商＊</h6>
                            <select class="form-control" id="company_id"></select>
                        </div>

                        <div class="col-lg-3 col-md-12 col-12"  id="types_custom">
                            <h6>類別＊</h6>
                            <select class="form-control" id="types"></select>
                        </div>
                    </div>

                    <div class="row my-3">
                        <div class="col-lg-3 col-md-12 col-12" id="brand_custom">
                            <h6>品牌＊</h6>
                            <select class="form-control" id="brand"></select>
                        </div>
                    </div>

                    <div class="row my-3">
                        <div class="col-lg-3 col-md-12 col-12" id="model_custom">
                            <h6>型號 / 編號＊</h6>
                            <select class="form-control" id="model"></select>
                        </div>
                        <div class="col-lg-3 col-md-12 col-12" id="name_custom">
                            <h6>品名＊</h6>
                            <select class="form-control" id="name"></select>
                        </div>
                    </div>

                    <div class="row my-3">
                        <div class="col-lg-6 col-md-12 col-12">
                            <h6>其他資訊</h6>
                            <textarea style="width:100%;height:100px;" id="info"></textarea>
                        </div>
                    </div>

    
                    <div class="row my-3">
                        <div class="col-lg-10 col-md-10 col-12">
                            <button class="btn btn-success" id="sub">更新</button>
                            <button class="btn btn-danger" id="close">關閉</button>
                        </div>
                        <div class="col-lg-2 col-md-2 col-12">
                            <button class="btn btn-danger" id="delete_check">刪除資料</button>
                        </div>
                    </div>
    
                </div>    
            </div>
            <button class="close">X</button>
        </div>
    </div>


    <div class="row">
        <div class="col-md-12 col-sm-12 ">
            <div class="x_panel">
                <div class="x_title">
                    <h2>廠商代理資訊</small></h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card-box table-responsive">
                                <p class="text-muted font-13 m-b-30">
                                The Buttons extension for DataTables provides a common set of options, API methods and styling to display buttons on a page that will interact with a DataTable. The core library provides the based framework upon which plug-ins can built.
                                </p>
                                <table id="datatable-buttons" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>廠商</th>
                                            <th>類別</th>
                                            <th>品牌</th>
                                            <th>型號 / 編號</th>
                                            <th>品名</th>
                                            <th>資訊</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for i in company_product_list%}
                                        <tr>
                                            <td><a href="#" onclick="get_id('{{i.id}}', '{{i.company}}', '{{i.company_name}}')">{{i.company_name}}</a></td>
                                            <td>{{i.types}}</td>
                                            <td>{{i.brand}}</td>                                              
                                            <td>{{i.model}}</td>
                                            <td>{{i.name}}</td>
                                            {% if i.info == None %}
                                                <td></td>
                                            {% else %}
                                                <td>{{i.info}}</td>
                                            {% endif %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /page content -->

{% endblock%}

{% block js %}
    <!-- iCheck -->
    <script src="{% static '/dashboard_plugin/datatable/iCheck/icheck.min.js' %}"></script>
    <!-- Datatables -->
    <script src="{% static '/dashboard_plugin/datatable/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons-bs/js/buttons.bootstrap.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/jszip/dist/jszip.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/pdfmake/build/pdfmake.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/pdfmake/build/vfs_fonts.js' %}"></script>


    <script>
    var _id = ''
    function get_id(id, company_id, company_name){
        var company_product_id = id
        _id = id   //更新引用 #sub
        var company_id = company_id
        $.ajax({
            url: '/company_product_list/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_product_id:company_product_id,
                company_id:company_id
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.company_name_list.legth != 0){
                    var company_data = '<option hidden select value="'+company_id+'">'+company_name+'</option>'
                    for(i=0; i< data.company_name_list.length; i++){
                        company_data += '<option value="'+data.company_id_list[i]+'">'+data.company_name_list[i]+'</option>'
                    }
                    document.getElementById('company_id').innerHTML = company_data
                    document.getElementById('types').innerHTML = '<option hidden select value="'+data.data['types']+'">'+data.data['types']+'</option>'
                    document.getElementById('brand').innerHTML = '<option hidden select value="'+data.data['brand']+'">'+data.data['brand']+'</option>'
                    document.getElementById('model').innerHTML = '<option hidden select value="'+data.data['model']+'">'+data.data['model']+'</option>'
                    document.getElementById('name').innerHTML = '<option hidden select value="'+data.data['name']+'">'+data.data['name']+'</option>'
                    $('#info').val(data.data['info']);
                    $('.lightbox').addClass('active')
                }else{
                    alert('Error：取得代理商品')
                }
            }
        });
    };

    $('#company_id').change(function(){
        var id_ = $('#company_id').val();
        document.getElementById('types').innerHTML = '<option hidden select value="">種類</option></option><option value="custom">自行新增</option>'        
        document.getElementById('brand').innerHTML = '<option hidden select value="">品牌</option></option><option value="custom">自行新增</option>'
        document.getElementById('model').innerHTML = '<option hidden select value="">型號 / 編號</option></option><option value="custom">自行新增</option>'
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option></option><option value="custom">自行新增</option>'
        $.ajax({
            url: '/get_company_product_types/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_id: id_
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data.length != 0 && data.data != 'error'){
                    var show_types = '<option hidden select value="">種類</option><option value="custom">自行新增</option>'
                    for(i=0; i<data.data.length; i++){
                        show_types += '<option value="'+data.data[i]+'">'+data.data[i]+'</option>'
                    }
                    document.getElementById('types').innerHTML = show_types
                }
            }
        });
    });

    $('#types').change(function(){
        var id_ = $('#company_id').val();
        var types = $('#types').val();
        document.getElementById('brand').innerHTML = '<option hidden select value="">品牌</option></option><option value="custom">自行新增</option>'
        document.getElementById('model').innerHTML = '<option hidden select value="">型號 / 編號</option></option><option value="custom">自行新增</option>'
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option></option><option value="custom">自行新增</option>'
        $.ajax({
            url: '/get_company_product_brand/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_id: id_,
                types: types
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data.length != 0 && data.data != 'error'){
                    var show_types = '<option hidden select value="">品牌</option><option value="custom">自行新增</option>'
                    for(i=0; i<data.data.length; i++){
                        show_types += '<option value="'+data.data[i]+'">'+data.data[i]+'</option>'
                    }
                    document.getElementById('brand').innerHTML = show_types
                }
            }
        });
    });


    $('#brand').change(function(){
        var id_ = $('#company_id').val();
        var types = $('#types').val();
        var brand = $('#brand').val();
        document.getElementById('model').innerHTML = '<option hidden select value="">型號 / 編號</option></option><option value="custom">自行新增</option>'
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option></option><option value="custom">自行新增</option>'
        $.ajax({
            url: '/get_company_product_model/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_id: id_,
                types: types,
                brand: brand
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data.length != 0 && data.data != 'error'){
                    var show_types = '<option hidden select value="">型號 / 編號</option><option value="custom">自行新增</option>'
                    for(i=0; i<data.data.length; i++){
                        show_types += '<option value="'+data.data[i]+'">'+data.data[i]+'</option>'
                    }
                    document.getElementById('model').innerHTML = show_types
                }
            }
        });
    });



    $('#model').change(function(){
        var id_ = $('#company_id').val();
        var types = $('#types').val();
        var brand = $('#brand').val();
        var model = $('#model').val();
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option></option><option value="custom">自行新增</option>'
        $.ajax({
            url: '/get_company_product_name/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_id: id_,
                types: types,
                brand: brand,
                model:model
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data.length != 0){
                    var show_types = '<option hidden select value="">品名</option><option value="custom">自行新增</option>'
                    for(i=0; i<data.data.length; i++){
                        show_types += '<option value="'+data.data[i]+'">'+data.data[i]+'</option>'
                    }
                    document.getElementById('name').innerHTML = show_types
                }
            }
        });
    });


    $("#brand").change(function(){
        if($("#brand").val() == 'custom'){
            $('#brand_custom').empty();
            document.getElementById('brand_custom').innerHTML = '<h6>品牌＊</h6><input class="form-control" type="text" id="brand">'
        }
    });

    $("#types").change(function(){
        if($("#types").val() == 'custom'){
            $('#types_custom').empty();
            document.getElementById('types_custom').innerHTML = '<h6>種類＊</h6><input class="form-control" type="text" id="types">'
        }
    });

    $("#model").change(function(){
        if($("#model").val() == 'custom'){
            $('#model_custom').empty();
            document.getElementById('model_custom').innerHTML = '<h6>型號 / 編號＊</h6><input class="form-control" type="text" id="model">'
        }
    });

    $("#name").change(function(){
        if($("#name").val() == 'custom'){
            $('#name_custom').empty();
            document.getElementById('name_custom').innerHTML = '<h6>品名＊</h6><input class="form-control" type="text" id="name">'
        }
    });


    function get_data(){
        var company_id = $('#company_id').val();
        var types = $('#types').val();
        var brand = $('#brand').val();
        var model = $('#model').val();
        var name = $('#name').val();
        var info = $('#info').val();
        var company_name = $("#company_id  option:selected").text();   //取select 的 name
        return {'company_id':company_id,'company_name':company_name,'types':types, 'brand':brand,'model': model, 'name':name,'info':info}
    };

    $('#sub').click(function(){
        var data = get_data()
        var company_product_id = _id
        data['company_product_id'] = company_product_id
        if(data['company_id'] == ''){
            alert ('請選擇廠商')
        }else if(!data['types'] || data['types'].trim().length === 0){
            alert ('請選擇種類')
        }else if(!data['brand'] || data['brand'].trim().length === 0){
            alert ('請選擇品牌')
        }else if(!data['model'] || data['model'].trim().length === 0){
            alert ('請選擇型號 / 編號')
        }else if(!data['name'] || data['name'].trim().length === 0){
            alert ('請輸入品名')
        }else{
            var upload = new FormData();                       // upload(因為image是file格式所以要跟json分開放 需用form的方式) 不能使用-> data:{data:JSON.stringify(data), image:image}
            upload.append("csrfmiddlewaretoken",$("[name='csrfmiddlewaretoken']").val());   
            upload.append("data",JSON.stringify(data));        //                           jaon類型使用 request.POST.get('data')
            $.ajax({
                url: '/company_product_update/', 
                type: 'POST',  
                data: upload,
                contentType: false,  
                processData: false,   
                success: function (data) {
                    var data = JSON.parse(data);
                    if(data.data == 'success'){
                        alert ('更新成功')
                        window.location.reload();
                    }else if(data.data == 'error'){
                        alert ('更新失敗')
                        window.location.reload();
                    }else if(data.data == 'exists'){
                        alert ('更新失敗 : 型號與品名重複')
                    }
                }
            });
        }
    })


    $('#delete_true').click(function(){
        var company_product_id = _id               
        $.ajax({
            url: '/company_product_delete/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_product_id: company_product_id
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data == 'success'){
                    alert ('刪除成功')
                    window.location.reload();
                }else if(data.data == 'error'){
                    alert ('刪除失敗')
                    window.location.reload();
                }
            }
        });

    });

    //按鈕關閉
    $('.close').click(function(){
        //$(".lightbox").removeClass("active");
        window.location.reload();
    });
    $('#close').click(function(){
        //$(".lightbox").removeClass("active");
        window.location.reload();
    });

    $('#delete_check').click(function(){          //確認刪除lightbox
        $('.lightbox2').addClass('active')      
    });

    $('#close_delete_check').click(function(){      //關閉確認刪除lightbox
        $(".lightbox2").removeClass("active");
    });

    </script>


{% endblock%}