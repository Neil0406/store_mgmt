{% extends 'base.html' %}
{% load static %}
{% block title %} 
<title>商品資訊</title>
{% endblock %}

{% block header%}
    <!-- Datatables -->
    <link href="{% static '/dashboard_plugin/datatable/datatables.net-bs/css/dataTables.bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static '/dashboard_plugin/datatable/datatables.net-buttons-bs/css/buttons.bootstrap.min.css' %}" rel="stylesheet">
    <!-- iCheck -->
    <link href="{% static '/dashboard_plugin/datatable/iCheck/skins/flat/green.css' %}" rel="stylesheet">

    <!-- fancybox -->
    <link href="{% static '/plugin/fancybox/jquery.fancybox.min.css' %}" rel="stylesheet">

{% endblock %}


{% block css %}
<style>
    #search{
        position: absolute;
        bottom: -4px;
        right: 10px;
    }

    #update_company_product_info_delete{
        position: absolute;
        bottom: 6px;
        right: 0;
    }
    .update_company_product_info_lightbox{
        z-index:9999;
        position: fixed;
        left: 0;    /* 靠左上角定位 */
        top: 0;	  
        width: 100%;
        height: 100vh;    /* view-width. height  */
        background-color: rgba(0,0,0,.5);
        align-items: center;
        justify-content: center;
        display: none;
    }
    .update_company_product_info_lightbox.active{
        display: flex;
    }
    .update_company_product_info_content{
        width: 250px;
        height: 150px;
        background-color: #ccc;
        border-radius: 10px;
        display:flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow-y:auto;
    }
  
    .show_image{
        width: auto;
        height: auto;
        max-width: 50%;
        max-height: 50%;
    }
    .default_image{
        object-fit: cover;
        width:50px;
        height:50px;
    }


</style>
{% endblock %}


{% block body %}
<!-- 商品列表 -->
<div class="container" role="main">
    <h4>商品資訊</h4><a href="/company/create_company_product"><button class="btn-success">新增商品</button></a>
    <div class="row my-1">
        <div class="col-md-12 col-sm-12 ">
            <div class="x_panel">
                <div class="x_title">
                    <h2>商品搜尋</small></h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card-box table-responsive">
   
                                <div class="col-lg-3 col-md-3 col-6">
                                    <h6>廠商</h6>
                                    <select id="search_company" class="form-control">
                                        <option hidden value="">廠商</option>
                                        {% for i in company_list%}
                                            <option value="{{i.id}}">{{i.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-lg-3 col-md-3 col-6">
                                    <h6>類別</h6>
                                    <select  id="search_types" class="form-control">
                                        <option hidden value="">類別</option>
                                        {% for i in company_product_types_list%}
                                            <option value="{{i}}">{{i}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-lg-3 col-md-3 col-6">
                                    <h6>型號</h6>
                                    <input id="search_keyword" type="text" class="form-control">
                                </div>
                                <div class="col-lg-3 col-md-3 col-6" id='search'>
                                    <button class="btn btn-primary" id="search_btn">查詢</button>
                                    <button class="btn btn-danger" id="search_btn_reset">清除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<div class="container" role="main">
    <div class="row my-1">
        <div class="col-md-12 col-sm-12 ">
            <div class="x_panel">
                <div class="x_title">
                    <h2>商品列表</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up" id="chevron"></i></a></li>
                      </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content" id="company_product_list">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card-box table-responsive">
                                <p class="text-muted font-13 m-b-30">
                                    商品列表
                                </p>
                                <table id="datatable-button" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>廠商</th>
                                            <th>種類</th>
                                            <th>品牌</th>
                                            <th>型號</th>
                                            <th>品名</th>
                                            <th>圖片</th>
                                            <th>進價</th>
                                            <th>售價</th>
                                            <th>更新時間</th>
                                        </tr>
                                    </thead>
                                    <tbody id = 'show_search'>
                                        <!-- {% for i in company_product_list%}
                                            {% if i.active == True %}
                                                <tr>
                                                    <td><a href="#" onclick="get_company_product_id('{{i.id}}','{{i.company.id}}')">{{i.company.name}}</a></td>
                                                    <td>{{i.types}}</td>
                                                    <td>{{i.brand}}</td>
                                                    <td>{{i.model}}</td>
                                                    <td>{{i.name}}</td>
                                                    <td>                                                            
                                                        {% if i.image1 %}
                                                        <a data-fancybox="gallery" href="/{{i.image1}}"><img src="/{{i.image1}}" alt="" class="default_image"></a>&nbsp;
                                                        {% endif %}
                                                        {% if i.image2%}
                                                        <a data-fancybox="gallery" href="/{{i.image2}}"><img src="/{{i.image2}}" alt="" class="default_image"></a>&nbsp;
                                                        {% endif %}
                                                        {% if i.image3%}
                                                        <a data-fancybox="gallery" href="/{{i.image3}}"><img src="/{{i.image3}}" alt="" class="default_image"></a>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{i.purchase_price |floatformat:-1 }}</td>
                                                    <td>{{i.selling_price |floatformat:-1 }}</td>
                                                    <td>{{i.updated |date:"Y-m-d" }}</td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %} -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / 商品列表 -->

<!-- / 商品管理 -->
<div class="container" role="main" id="company_product_info" style="display: none;">

    <div class="update_company_product_info_lightbox">
        <div class="update_company_product_info_content">
            <div>
                <h5>確定要刪除？</h5><br>
                <div>
                    <button class="btn btn-success" id='update_company_product_info_delete_true'>確認</button>
                    <button class="btn btn-danger" id="close_update_company_product_info_delete_check">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row my-1">
        {% csrf_token %}
        <div class="col-md-12 col-sm-12 ">
            <div class="x_panel">
                <div class="x_title">
                    <h2>商品資料更新</small></h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <!-- <div class="row">

                        <div class="col-lg-6 col-md-12 col-12"> -->
                            <div class="row my-2">
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>廠商</h6>
                                    <input type="text" id="company_name" class="form-control" disabled>
                                </div>
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>類別</h6>
                                    <input type="text" id="types" class="form-control">
                                </div>
                            </div>
        
                            <div class="row my-2">
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>品牌</h6>
                                    <input type="text" id="brand" class="form-control">
                                </div>
                            </div>
        
                            <div class="row my-2">
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>型號 / 編號</h6>
                                    <input type="text" id="model" class="form-control">
                                </div>
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>品名＊</h6>
                                    <input type="text" id="name" class="form-control">
                                </div>
                            </div>
        
                            <div class="row my-2">
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>進價(單價)＊</h6>
                                    <input id="purchase_price" type="number" class="form-control" type="number" step=any>
                                </div>
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>售價(單價)＊</h6>
                                    <input id="selling_price" type="number" class="form-control" type="number" step=any>
                                </div>
                            </div>

                            <div class="row my-2">
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>圖片1</h6>
                                    <img src="" alt="" id="show_image1" class="show_image"><br>
                                    <button type="btn" class="btn-danger" id="delete_image1" onclick="delete_image(1)" style="display: none;">刪除照片</button>
                                    <input type="file" id="image1" accept="image/gif, image/jpeg, image/png" multiple="multiple" class="image_up">
                                </div>
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>圖片2</h6>
                                    <img src="" alt="" id="show_image2" class="show_image"><br>
                                    <button type="btn" class="btn-danger" id="delete_image2" onclick="delete_image(2)" style="display: none;">刪除照片</button>
                                    <input type="file" id="image2" accept="image/gif, image/jpeg, image/png" multiple="multiple" class="image_up">
                                </div>
                                <div class="col-lg-3 col-md-6 col-6">
                                    <h6>圖片3</h6>
                                    <img src="" alt="" id="show_image3" class="show_image"><br>
                                    <button type="btn" class="btn-danger" id="delete_image3"  onclick="delete_image(3)"  style="display: none;">刪除照片</button>
                                    <input type="file" id="image3" accept="image/gif, image/jpeg, image/png" multiple="multiple" class="image_up">
                                </div>
                            </div>
        
                            <div class="row my-2">
                                <div class="col-lg-6 col-md-12 col-12">
                                    <h6>其他資訊</h6>
                                    <textarea id="info" style="width:100%;height:200px;"></textarea>
                                </div>
                            </div>
                        <!-- </div>  
                    </div> -->
                    <br>
                    <button class="btn btn-primary" id="update_company_product">更新</button>
                    <button class="btn btn-danger" id="update_company_product_info_close">關閉</button>
                    <button class="btn btn-danger" id="update_company_product_info_delete">刪除商品</button>

                </div>
            </div>
        </div>
    </div>
</div>
<br>
<!-- / 商品管理 -->
{% endblock %}

{% block js %}
    <!-- iCheck -->
    <script src="{% static '/dashboard_plugin/datatable/iCheck/icheck.min.js' %}"></script>
    <!-- Datatables -->
    <script src="{% static '/dashboard_plugin/datatable/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons-bs/js/buttons.bootstrap.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/jszip/dist/jszip.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/pdfmake/build/pdfmake.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/pdfmake/build/vfs_fonts.js' %}"></script>

    <!-- fancybox -->
    <script src="{% static '/plugin/fancybox/jquery.fancybox.min.js' %}"></script>


    <script>

        $('#search_btn_reset').click(function(){
            $('#search_company').val('');
            $('#search_types').val('');
            $('#search_keyword').val('');
        });

        $('#search_btn').click(function(){
            $('#show_search').empty();
            var company_id = $('#search_company').val();
            var types = $('#search_types').val();
            var keyword = $('#search_keyword').val();
            if(company_id.trim().length === 0 && types.trim().length === 0 && keyword.trim().length === 0){
                alert ('請輸入搜尋')
            }
            $.ajax({
                url: '/company/company_product_search/', 
                type: 'POST',  
                headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
                data: {
                    company_id: company_id,
                    types:types,
                    keyword:keyword
                },  
                success: function (data) {
                    var data = JSON.parse(data);
                    if (data.data.length != 0){
                        var s = ''
                        for(i=0; i< data.data.length; i++){
                            s += '<tr><td><a href="#" onclick="get_company_product_id('+data.data[i].id+','+data.data[i].company+')">'+data.data[i].company_name+'</a></td><td>'+data.data[i].types+'</td><td>'+data.data[i].brand+'</td><td>'+data.data[i].model+'</td><td>'+data.data[i].name+'</td><td>'
                            if(data.data[i].image1 != ''){
                                s +='<a data-fancybox="gallery" href="/'+data.data[i].image1+'"><img src="/'+data.data[i].image1+'" alt="" class="default_image"></a>&nbsp;'
                            }
                            if(data.data[i].image2 != ''){
                                s +='<a data-fancybox="gallery" href="/'+data.data[i].image2+'"><img src="/'+data.data[i].image2+'" alt="" class="default_image"></a>&nbsp;'
                            }
                            if(data.data[i].image3 != ''){
                                s +='<a data-fancybox="gallery" href="/'+data.data[i].image3+'"><img src="/'+data.data[i].image3+'" alt="" class="default_image"></a>&nbsp;'
                            }
                            s+= '</td><td>'+data.data[i].purchase_price+'</td><td>'+data.data[i].selling_price+'</td><td>'+data.data[i].updated+'</td></tr>'
                        }
                        $('#show_search').html(s);
                        $('#datatable-button').DataTable().ajax.reload
                        
                    }else{
                        alert ('查無資料')
                    }
                }
            });

        });




        var company_product_id_ = ''
        var company_id_ = ''
        function get_company_product_id(company_product_id, company_id){
            company_product_id_ = company_product_id
            company_id_ = company_id
            $('#show_image1').attr('src','')
            $('#show_image2').attr('src','')
            $('#show_image3').attr('src','')
            document.getElementById('delete_image1').style.display = 'none'
            document.getElementById('delete_image2').style.display = 'none'
            document.getElementById('delete_image3').style.display = 'none'
            $.ajax({
                url: '/company/get_update_company_product/', 
                type: 'POST',  
                headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
                data: {
                    company_product_id: company_product_id,
                },
                success: function (data) {
                    var data = JSON.parse(data);
                    data = data.data
                    $('#company_name').val(data.company);
                    $('#types').val(data.types);
                    $('#brand').val(data.brand);
                    $('#model').val(data.model);
                    $('#name').val(data.name);
                    $('#purchase_price').val(data.purchase_price);
                    $('#selling_price').val(data.selling_price);
                    $('#info').val(data.info);

                    if(data.image1 != ''){
                        $('#show_image1').attr('src', '/'+data.image1)
                        document.getElementById('delete_image1').style.display = 'block'
                    }
                    if(data.image2 != ''){
                        $('#show_image2').attr('src', '/'+data.image2)
                        document.getElementById('delete_image2').style.display = 'block'
                    }
                    if(data.image3 != ''){
                        $('#show_image3').attr('src', '/'+data.image3)
                        document.getElementById('delete_image3').style.display = 'block'
                    }

                    document.getElementById('company_product_list').style.display = 'none'
                    document.getElementById('chevron').className = 'fa fa-chevron-down'
                    document.getElementById('company_product_info').style.display = 'block'

                }
            });
        }

        function get_image(){
            var upload_image = []
            var image_list = $("*[class='image_up']")
            for(i=0; i<image_list.length; i++){
                var input = image_list[i]
                if(input.files && input.files[0]){
                    upload_image.push(input.files[0])
                }else{
                    upload_image.push('')
                }
            }
            return upload_image
        }
        
        function delete_image(num){
            num = String(num)
            document.getElementById('show_image'+ num).src = ''
            $('#image'+ num).val('');
            document.getElementById('delete_image' + num).style.display = 'none'
        }
    
        $("*[class='image_up']").change(function(){
            var image_list = $("*[class='image_up']")
            for(i=0; i<image_list.length; i++){
                var input = image_list[i]
                if(input.files && input.files[0]){
                    var _id = image_list[i].id
                    //console.log(_id)
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $("#show_"+_id).attr('src', e.target.result);
                    }
                    document.getElementById('delete_image'+ String(i+1)).style.display = 'block'
                    reader.readAsDataURL(input.files[0]);
                }
            }
        })

        function get_data(){
            var types = $('#types').val();
            var brand = $('#brand').val();
            var model = $('#model').val();
            var name = $('#name').val();
            var info = $('#info').val();
            var purchase_price = $('#purchase_price').val();
            var selling_price = $('#selling_price').val();
            return {'company_id':company_id_,'company_product_id':company_product_id_,'types':types, 'brand':brand, 'model':model, 'name':name, 'info':info, 'purchase_price':purchase_price, 'selling_price':selling_price}
        }
    
    
        $('#update_company_product').click(function(){
            var data = get_data()
            if(!data['types'] || data['types'].trim().length === 0){
                alert ('請輸入類別')
            }else if(!data['brand'] || data['brand'].trim().length === 0){
                alert ('請輸入品牌')
            }else if(!data['model'] || data['model'].trim().length === 0){
                alert ('請輸入型號 / 編號')
            }else if(!data['name'] || data['name'].trim().length === 0){
                alert ('請輸入品名')
            }else if(!data['purchase_price'] || data['purchase_price'].trim().length === 0){
                alert ('請輸入進價(單價)')
            }else if(!data['selling_price'] || data['selling_price'].trim().length === 0){
                alert ('請輸入售價(單價)')
            }
            else{
                var url = window.location.href
                var image_data = get_image();
                var upload = new FormData();                              // upload(因為image是file格式所以要跟json分開放 需用form的方式) 不能使用-> data:{data:JSON.stringify(data), image:image}
                upload.append("csrfmiddlewaretoken",$("[name='csrfmiddlewaretoken']").val()); 
                upload.append("data",JSON.stringify(data));
                for(i=0; i<image_data.length; i++){
                    if(image_data[i] == '' && document.getElementById('show_image' + String(i+1)).src + '#' != url){
                        //不更新
                        upload.append("image" + String(i+1), 'no_update');
                    }else if(image_data[i] != ''){
                        //更新
                        upload.append("image" + String(i+1),image_data[i]);
                    }else if(image_data[i] == '' && document.getElementById('show_image' + String(i+1)).src + '#' == url){
                        //刪除 / 不新增
                        upload.append("image"+ String(i+1), '');
                    }
                }
                $.ajax({
                    url: '/company/update_company_product/', 
                    type: 'POST',  
                    contentType: false,  
                    processData: false,   
                    data: upload,
                    success: function (data) {
                        var data = JSON.parse(data);
                        if(data.data == 'success'){
                            alert ('更新成功')
                            window.location.reload();
                        }else if(data.data == 'error'){
                            alert ('更新失敗')
                        }else if(data.data == 'exists'){
                            alert ('更新失敗 : 型號與品名重複')
                        }
                    }
                });
            }
        });


        $('#update_company_product_info_delete_true').click(function(){
            $.ajax({
                url: '/company/delete_company_product/', 
                type: 'POST',  
                headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
                data: {
                    company_product_id: company_product_id_,
                },  
                success: function (data) {
                    var data = JSON.parse(data);
                    if(data.data == 'success'){
                        alert ('刪除成功')
                        window.location.reload();
                    }else if(data.data == 'error'){
                        alert ('刪除失敗')
                    }
                }
            });
        });

        $('#update_company_product_info_delete').click(function(){
            $('.update_company_product_info_lightbox').addClass('active')
        })

        $('#close_update_company_product_info_delete_check').click(function(){
            $('.update_company_product_info_lightbox').removeClass('active')
        })

        $('#update_company_product_info_close').click(function(){
            document.getElementById('company_product_info').style.display = 'none'
            document.getElementById('chevron').className = 'fa fa-chevron-up'
            document.getElementById('company_product_list').style.display = 'block'
        });

    </script>

{% endblock %}