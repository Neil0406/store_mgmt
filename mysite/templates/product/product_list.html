{% extends  'base.html' %}
{% load static %}
{% block title%}
<title>庫存資訊</title>  
{% endblock %}


{% block header%}
    <!-- Datatables -->
    <link href="{% static '/dashboard_plugin/datatable/datatables.net-bs/css/dataTables.bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'dashboard_plugin/datatable/datatables.net-buttons-bs/css/buttons.bootstrap.min.css' %}" rel="stylesheet">
    <!-- iCheck -->
    <link href="{% static '/dashboard_plugin/datatable/iCheck/skins/flat/green.css' %}" rel="stylesheet">
{% endblock %}
{% block css %}

<style>
    *{
        font-family:"Arial","蘋方體","微軟正黑體",sans-serif
      }
    body {
        background-color:rgb(241, 241, 241);
    }
    .lightbox{
        z-index:5000;
        position: fixed;
        left: 0;    /* 靠左上角定位 */
        top: 0;	  
        width: 100%;
        height: 100vh;    /* view-width. height  */
        background-color: rgba(0,0,0,.5);
        align-items: center;
        justify-content: center;
        display: none;

    }
    .lightbox.active{
        display: flex;
    }
    .content{
        width: 1200px;
        height: 800px;
        background-color: #ccc;
        /*align-items: center;
        justify-content: center;  */
        position: relative;
        overflow-y:auto;

    }
    .close{
        z-index:9999;
        position: absolute;
        top: 0;
        right: 0;
    }

    .lightbox2{
        z-index:9999;
        position: fixed;
        left: 0;    /* 靠左上角定位 */
        top: 0;	  
        width: 100%;
        height: 100vh;    /* view-width. height  */
        background-color: rgba(0,0,0,.5);
        align-items: center;
        justify-content: center;
        display: none;
    }
    .lightbox2.active{
        display: flex;
    }
    .content_delete_check{
        width: 250px;
        height: 150px;
        background-color: #ccc;
        border-radius: 10px;
        display:flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow-y:auto;

    }

    img{
        width: auto;
        height: auto;
        max-width: 80%;
        max-height: 80%;	
    }
    


</style>
{% endblock%}
{% block body %}

<!-- page content -->
<div class="container" role="main">

    <div class="lightbox2">
        <div class="content_delete_check">
            <div>
                <h5>確定要刪除資料？</h5><br>
                <div>
                    <button class="btn btn-success" id='delete_true'>確認刪除</button>
                    <button class="btn btn-danger" id="close_delete_check">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div class="lightbox">
        <div class="content" id='show_update'>
            <div class="card col-12">
                <br>
                <h5 style="text-align: center;">進貨紀錄更新</h5>
                <div class="card-body">
                    {% csrf_token %}
                    <div class="row my-3">
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>廠商＊</h6>
                            <select class="form-control" id="company"></select>
                        </div>        
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>種類＊</h6>
                            <select class="form-control" id="types"></select>
                        </div>
                    </div>
    
                    <div class="row my-3">
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>品牌＊</h6>
                            <select class="form-control" id="brand"></select>
                        </div>
                    </div>
                    
           
                    <div class="row my-3">
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>型號 / 編號＊</h6>
                            <select class="form-control" id="model"></select>
                        </div>
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>品名＊</h6>
                            <select class="form-control" id="name"></select>                     
                        </div>
                    </div>
    
                    <div class="row my-3">
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>進價＊</h6>
                            <input class="form-control" type="number" step=any id="purchase_price">
                        </div>
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>售價＊</h6>
                            <input class="form-control" type="number" step=any id="selling_price">
                        </div>
                    </div>
                    <div class="row my-3">
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>數量＊</h6>
                            <input class="form-control" type="number" step=any id="amount">
                        </div>
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>庫存數量＊</h6>
                            <input class="form-control" type="number" step=any id="product_in_stock">
                        </div>
                    </div>
    
                    <div class="row my-3">
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>進貨日期</h6>
                            <input class="form-control" type="date" id="purchase_date">
                        </div>
                    </div>
    
                    <div class="row my-3">
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>圖片1</h6>
                            <input type="file" id="image" accept="image/*" multiple="multiple" style="display: none;"> 
                            <div id="show_image"></div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>圖片2</h6>
                            <input type="file" id="image2" accept="image/*" multiple="multiple" style="display: none;"> 
                            <div id="show_image2"></div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-6">
                            <h6>圖片3</h6>
                            <input type="file" id="image3" accept="image/*" multiple="multiple" style="display: none;"> 
                            <div id="show_image3"></div>
                        </div>
                    </div>
    
                    <div class="row my-3">
                        <div class="col-lg-6 col-md-12 col-12">
                            <h6>其他資訊</h6>
                            <textarea style="width:100%;height:100px;" id="info"></textarea>
                        </div>
                    </div>
    
                    <div class="row my-3">
                        <div class="col-lg-10 col-md-10 col-12">
                            <button class="btn btn-success" id="sub">更新</button>
                            <button class="btn btn-danger" id="reset">清除</button>
                            <button class="btn btn-danger" id="close">關閉</button>
                        </div>
                        <div class="col-lg-2 col-md-2 col-12">
                            <button class="btn btn-danger" id="delete_check">刪除資料</button>
                        </div>
                    </div>
    
                </div>    
            </div>
            <button class="close">X</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12 col-sm-12 ">
            <div class="x_panel">
                <div class="x_title">
                    <h2>庫存資訊</small></h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card-box table-responsive">
                                <p class="text-muted font-13 m-b-30">
                                The Buttons extension for DataTables provides a common set of options, API methods and styling to display buttons on a page that will interact with a DataTable. The core library provides the based framework upon which plug-ins can built.
                                </p>
                                <table id="datatable-buttons" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>廠商</th>
                                            <th>類別</th>
                                            <th>品牌</th>
                                            <th>型號 / 編號</th>
                                            <th>品名</th>
                                            <th>進價</th>
                                            <th>售價</th>
                                            <th>數量</th>
                                            <th>庫存數量</th>
                                            <th>進貨日</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for i in product_list %}
                                        <tr>
                                            <td><a href="#" onclick="get_id('{{i.id}}','{{i.company}}')">{{i.company}}</a></td>
                                            <td>{{i.types}}</td>
                                            <td>{{i.brand}}</td>
                                            <td>{{i.model}}</td>
                                            <td>{{i.name}}</td>
                                            <td>{{i.purchase_price |floatformat:-2}}</td>
                                            <td>{{i.selling_price |floatformat:-2}}</td>
                                            <td>{{i.amount |floatformat:-2 }}</td>
                                            <td>{{i.product_in_stock |floatformat:-2 }}</td>
                                            <td>{{i.purchase_date|date:"Y-m-d"}}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
  <!-- /page content -->

{% endblock %}


{% block js %}
    <!-- iCheck -->
    <script src="{% static '/dashboard_plugin/datatable/iCheck/icheck.min.js' %}"></script>
    <!-- Datatables -->
    <script src="{% static '/dashboard_plugin/datatable/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons-bs/js/buttons.bootstrap.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/jszip/dist/jszip.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/pdfmake/build/pdfmake.min.js' %}"></script>
    <script src="{% static '/dashboard_plugin/datatable/pdfmake/build/vfs_fonts.js' %}"></script>

    <script>


        $('#delete_check').click(function(){          //確認刪除lightbox
            $('.lightbox2').addClass('active')      
        });

        $('#close_delete_check').click(function(){      //關閉確認刪除lightbox
            $(".lightbox2").removeClass("active");
        });

        $('#delete_true').click(function(){
            product_id = _id                //進貨表的商品id
            $.ajax({
                url: '/product_delete/', 
                type: 'POST',  
                headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
                data: {
                    product_id: product_id
                },
                success: function (data) {
                    var data = JSON.parse(data);
                    if(data.data == 'success'){
                        alert ('刪除成功')
                        window.location.reload();
                    }else if(data.data == 'error'){
                        alert ('刪除失敗')
                        window.location.reload();
                    }
                }
            });

        });
    

        var image_check = ''
        var image_check2 = ''
        var image_check3 = ''
        var _id = ''
        function get_id(product_id, company){
            _id = product_id
            $('#show_image').empty();
            $.ajax({
                url: '/product_list/', 
                type: 'POST',  
                headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
                data: {
                    product_id:product_id,
                },
                success: function (data) {
                    var data = JSON.parse(data);
                    if(data.data.legth != 0){
                        var company_id = data.data['company']

                        var company_data = '<option hidden select value="'+company_id+'">'+company+'</option>'
                        for(i=0; i<data.company_name_list.length; i++){
                            company_data += '<option value="'+data.company_id_list[i]+'">'+data.company_name_list[i]+'</option>'
                        };
                        document.getElementById('company').innerHTML = company_data
                        document.getElementById('types').innerHTML = '<option hidden select value="'+data.data['types']+'">'+data.data['types']+'</option>'
                        document.getElementById('brand').innerHTML = '<option hidden select value="'+data.data['brand']+'">'+data.data['brand']+'</option>'
                        document.getElementById('model').innerHTML = '<option hidden select value="'+data.data['model']+'">'+data.data['model']+'</option>'
                        document.getElementById('name').innerHTML = '<option hidden select value="'+data.data['name']+'">'+data.data['name']+'</option>'
        
                        $('#purchase_price').val(data.data['purchase_price']);
                        $('#selling_price').val(data.data['selling_price']);
                        $('#amount').val(data.data['amount']);
                        $('#product_in_stock').val(data.data['product_in_stock']);
                        $('#purchase_date').val(data.data['purchase_date']);
                        $('#info').val(data.data['info']);
                        if(data.data.image != ''){
                            document.getElementById('image').style.display = 'none'
                            path = '../'+data.data.image
                            document.getElementById('show_image').innerHTML += '<br><img id="default_image" src="'+path+'" alt=""><button type="btn" class="btn-danger" onclick="delete_image()">刪除圖片</button>'
                            image_check = document.getElementById('default_image').src
                        }else{
                            document.getElementById('image').style.display = 'block'
                        }
                        if(data.data.image2 != ''){
                            document.getElementById('image2').style.display = 'none'
                            path2 = '../'+data.data.image2
                            document.getElementById('show_image2').innerHTML += '<br><img id="default_image2" src="'+path2+'" alt=""><button type="btn" class="btn-danger" onclick="delete_image2()">刪除圖片</button>'
                            image_check2 = document.getElementById('default_image2').src
                        }else{
                            document.getElementById('image2').style.display = 'block'
                        }
                        if(data.data.image3 != ''){
                            document.getElementById('image3').style.display = 'none'
                            path3 = '../'+data.data.image3
                            document.getElementById('show_image3').innerHTML += '<br><img id="default_image3" src="'+path3+'" alt=""><button type="btn" class="btn-danger" onclick="delete_image3()">刪除圖片</button>'
                            image_check3 = document.getElementById('default_image3').src
                        }else{
                            document.getElementById('image3').style.display = 'block'
                        }
                        $('.lightbox').addClass('active')
                    }
                }
            });
        };
    
    function delete_image(){
        image_check = ''
        $('#show_image').empty();
        document.getElementById('image').style.display = 'block'
    }
    function delete_image2(){
        image_check2 = ''
        $('#show_image2').empty();
        document.getElementById('image2').style.display = 'block'
    }
    function delete_image3(){
        image_check3 = ''
        $('#show_image3').empty();
        document.getElementById('image3').style.display = 'block'
    }

    function get_data(){
        var company_id = $('#company').val();
        var types = $('#types').val();
        var brand = $('#brand').val();
        var model = $('#model').val();
        var name = $('#name').val();
        var purchase_price = $('#purchase_price').val();
        var selling_price = $('#selling_price').val();
        var amount = $('#amount').val();
        var product_in_stock = $('#product_in_stock').val();
        var info = $('#info').val();
        var purchase_date = $('#purchase_date').val();
        var company_name = $("#company  option:selected").text();   //取select 的 name
        return {'company_name':company_name, 'company_id':company_id,'types':types,'brand':brand,'model':model,'name':name,'purchase_price':purchase_price, 
        'selling_price': selling_price,'amount':amount,'product_in_stock':product_in_stock,'info':info,'purchase_date':purchase_date}
    };


    $('#sub').click(function(){
        var data = get_data();
        data['id'] = _id    //上面的product_id
        if(data['company_id'] == ''){
            alert ('請選擇廠商')
        }else if(!data['types'] || data['types'].trim().length === 0){
            alert ('請選擇種類')
        }else if(!data['brand'] || data['brand'].trim().length === 0){
            alert ('請選擇品牌')
        }else if(!data['model'] || data['model'].trim().length === 0){
            alert ('請選擇型號 / 編號')
        }else if(!data['name'] || data['name'].trim().length === 0){
            alert ('請輸入品名')
        }else if(!data['purchase_price'] || data['purchase_price'].trim().length === 0){
            alert ('請輸入進價')
        }else if(!data['selling_price'] || data['selling_price'].trim().length === 0){
            alert ('請輸入售價')
        }else if(!data['amount'] || data['amount'].trim().length === 0){
            alert ('請輸入數量')
        }else if(!data['product_in_stock'] || data['product_in_stock'].trim().length === 0){
            alert ('請輸入庫存數量')
        }
        else{
            //var image = $("#image")[0].files[0]
            var image = $("#image")[0].files
            var image2 = $("#image2")[0].files
            var image3 = $("#image3")[0].files
            var upload = new FormData();                              // upload(因為image是file格式所以要跟json分開放 需用form的方式) 不能使用-> data:{data:JSON.stringify(data), image:image}
            upload.append("csrfmiddlewaretoken",$("[name='csrfmiddlewaretoken']").val());   
            //upload.append("image",image);
            upload.append("data",JSON.stringify(data));               //                           jaon類型使用 request.POST.get('data')
            if(image.length != 0){
                upload.append("image",image[0]);                      //upload到後端會是一個object   file類型使用 request.FILES['image']
            }else if(image_check != ''){
                upload.append("image",JSON.stringify({'type':'no_update'}))
            }else{
                upload.append("image",'')
            };
            if(image2.length != 0){
                upload.append("image2",image2[0]);                     
            }else if(image_check2 != ''){
                upload.append("image2",JSON.stringify({'type2':'no_update'}))
            }else{
                upload.append("image2",'')
            };
            if(image3.length != 0){
                upload.append("image3",image3[0]);                      
            }else if(image_check3 != ''){
                upload.append("image3",JSON.stringify({'type3':'no_update'}))
            }else{
                upload.append("image3",'')
            };
            $.ajax({
                url: '/product_update/', 
                type: 'POST',  
                data: upload,
                contentType: false,  
                processData: false,   
                success: function (data) {
                    var data = JSON.parse(data);
                    if(data.data == 'success'){
                        alert ('更新成功')
                        window.location.reload();
                    }else if(data.data == 'error'){
                        alert ('更新失敗')
                        window.location.reload();
                    }
                }
            });
        }
       
    });


    $('#company').change(function(){
        var id_ = $('#company').val();
        document.getElementById('types').innerHTML = '<option hidden select value="">種類</option>'
        document.getElementById('brand').innerHTML = '<option hidden select value="">品牌</option>'
        document.getElementById('model').innerHTML = '<option hidden select value="">型號 / 編號</option>'
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option>'
        $.ajax({
            url: '/get_company_product_types/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_id: id_
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data.length != 0 && data.data != 'error'){
                    var show_types = '<option hidden select value="">種類</option>'
                    for(i=0; i<data.data.length; i++){
                        show_types += '<option value="'+data.data[i]+'">'+data.data[i]+'</option>'
                    }
                    document.getElementById('types').innerHTML = show_types
                }else{
                    document.getElementById('types').innerHTML ='<option hidden select value="">沒有商品</option>'
                }
            }
        });
    });

    $('#types').change(function(){
        document.getElementById('brand').innerHTML = '<option hidden select value="">品牌</option>'
        document.getElementById('model').innerHTML = '<option hidden select value="">型號 / 編號</option>'
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option>'
        var id_ = $('#company').val();
        var types = $('#types').val();
        $.ajax({
            url: '/get_company_product_brand/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_id: id_,
                types: types
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data.length != 0 && data.data != 'error'){
                    var show_types = '<option hidden select value="">品牌</option>'
                    for(i=0; i<data.data.length; i++){
                        show_types += '<option value="'+data.data[i]+'">'+data.data[i]+'</option>'
                    }
                    document.getElementById('brand').innerHTML = show_types
                }
            }
        });
    });


    $('#brand').change(function(){
        document.getElementById('model').innerHTML = '<option hidden select value="">型號 / 編號</option>'
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option>'
        var id_ = $('#company').val();
        var types = $('#types').val();
        var brand = $('#brand').val();
        $.ajax({
            url: '/get_company_product_model/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_id: id_,
                types: types,
                brand: brand
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data.length != 0 && data.data != 'error'){
                    var show_types = '<option hidden select value="">型號 / 編號</option>'
                    for(i=0; i<data.data.length; i++){
                        show_types += '<option value="'+data.data[i]+'">'+data.data[i]+'</option>'
                    }
                    document.getElementById('model').innerHTML = show_types
                }
            }
        });
    });



    $('#model').change(function(){
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option>'
        var id_ = $('#company').val();
        var types = $('#types').val();
        var brand = $('#brand').val();
        var model = $('#model').val();
        $.ajax({
            url: '/get_company_product_name/', 
            type: 'POST',  
            headers: {'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()},
            data: {
                company_id: id_,
                types: types,
                brand: brand,
                model:model
            },
            success: function (data) {
                var data = JSON.parse(data);
                if(data.data.length != 0){
                    var show_types = '<option hidden select value="">品名</option>'
                    for(i=0; i<data.data.length; i++){
                        show_types += '<option value="'+data.data[i]+'">'+data.data[i]+'</option>'
                    }
                    document.getElementById('name').innerHTML = show_types
                }
            }
        });
    });

    function today() {
        var NowDate = new Date();
        var y = NowDate.getFullYear();
        var m = NowDate.getMonth() + 1;
        var d = NowDate.getDate();
        m = ("0" + m).slice(-2);
        d = ("0" + d).slice(-2);
        return y + '-'+ m + '-' + d
      };

    //按鈕關閉
    $('.close').click(function(){
        $(".lightbox").removeClass("active");
    });
    $('#close').click(function(){
        $(".lightbox").removeClass("active");
    });


    $('#reset').click(function(){
        document.getElementById('types').innerHTML = '<option hidden select value="">種類</option>'
        document.getElementById('brand').innerHTML = '<option hidden select value="">品牌</option>'
        document.getElementById('model').innerHTML = '<option hidden select value="">型號 / 編號</option>'
        document.getElementById('name').innerHTML = '<option hidden select value="">品名</option>'
        $('#purchase_price').val('');
        $('#selling_price').val('');
        $('#amount').val('');
        $('#info').val('');
        $('#purchase_date').val(today());
        $("#image").val('');
        $("#image2").val('');
        $("#image3").val('');
        delete_image();
        delete_image2();
        delete_image3();
    });
    
    </script>


{% endblock %}